const request = require('request').defaults({followAllRedirects: false})
const fs = require('../fs')
const log = require('../log')

exports.fire = (data) => {
    const { wpURL, siteURL, userAgent, silentMode } = data
    const filterName = fs.fileName( __filename, '.js' )
    const logObj = { silentMode, filterName }
    const targetURL = `${wpURL}/wp-includes/rss.php`

    request({
        'url': targetURL,
        'method': 'GET',
        'headers': {'User-Agent': userAgent}
    }, (error, response, body) => {

        if (error || response.statusCode === 404) {
            return log.info(`${targetURL} is not found`, logObj)
        }

        if(body.includes('__deprecated_file')) {
            return log.warn('${siteURL} is affected by FFD vulnerability', logObj)
        }

        return log.ok(`${siteURL} is not affected by FFD vulnerability`, logObj)
    })

}